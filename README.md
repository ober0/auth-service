# Сервис авторизации

Данный сервис предоставляет готовый функционал для управления пользователями, сессиями и ролями. Это универсальное решение, которое можно взять за основу для создания полноценной системы авторизации и аутентификации в любом проекте.

## Запуск

### 1. Настройка окружения

Перед запуском проекта необходимо создать файл `.env` и добавить в него следующие параметры:

```env
DATABASE_URL=""                 # URL подключения к базе данных
PORT=                           # Порт, на котором будет работать сервис
JWT_SECRET=""                   # Секретный ключ для работы JWT
SMTP_SERVICE_NAME="yandex"      # Имя SMTP сервиса
SMTP_USER=""                    # Логин для SMTP сервера
SMTP_PASSWORD=''                # Пароль для SMTP сервера
REDIS_HOST=""                   # Хост Redis
REDIS_PORT=                      # Порт Redis
```

### 2. Создать БД и выполнить миграции:

```shell
npx prisma migrate deploy
```

### 3. Выполнить генерацию Prisma:

```shell
npx prisma generate
```

### 4. Выполнить сиды для бд:

```shell
npm run seed
```

### 5. Запустить postgres и redis

### 6. Запустить сервер:

```bash
$ npm run start
```

---

## Возможности:

- Управление пользователями (CRUD).
- Работа с ролями (пользователь, модератор, администратор).
- Авторизация через `access` и `refresh` токены.
- Управление сессиями пользователей (завершение всех сессий, завершение конкретной сессии).
- Защита с помощью JWT и Guard.
- Система подтверждения учетной записи через Email.

---

## Маршруты

### 1. **Администрирование**

#### **Назначение модератора**

- **Метод**: `PATCH`
- **URL**: `/api/admin/make/moderator`
- **Защита**: `JwtAuthGuard`, `AdminGuard`
- **Описание**: Назначает указанного пользователя модератором.
- **Тело запроса**:
    ```json
    {
      "id": number
    }
    ```

#### **Удаление модератора**

- **Метод**: `PATCH`
- **URL**: `/api/admin/delete/moderator`
- **Защита**: `JwtAuthGuard`, `AdminGuard`
- **Описание**: Удаляет статус модератора у указанного пользователя.
- **Тело запроса**:
    ```json
    {
      "id": number
    }
    ```

#### **Назначение администратора**

- **Метод**: `PATCH`
- **URL**: `/api/admin/make/admin`
- **Защита**: `JwtAuthGuard`, `AdminGuard`, `ConfirmGuard`
- **Описание**: Назначает указанного пользователя администратором.
- **Тело запроса**:
    ```json
    {
      "id": number
    }
    ```

#### **Удаление администратора**

- **Метод**: `PATCH`
- **URL**: `/api/admin/delete/admin`
- **Защита**: `JwtAuthGuard`, `AdminGuard`
- **Описание**: Удаляет статус администратора у указанного пользователя.
- **Тело запроса**:
    ```json
    {
      "id": number
    }
    ```

---

### 2. **Авторизация**

#### **Вход**

- **Метод**: `POST`
- **URL**: `/api/auth`
- **Описание**: Авторизует пользователя и возвращает токены.
- **Тело запроса**:
    ```json
    {
        "email": "string",
        "password": "string"
    }
    ```

#### **Обновление токенов**

- **Метод**: `POST`
- **URL**: `/api/auth/refresh`
- **Описание**: Обновляет `access` и `refresh` токены.
- **Тело запроса**:
    ```json
    {
        "refresh_token": "string"
    }
    ```

---

### 3. **Управление сессиями для администраторов**

#### **Завершение всех сессий**

- **Метод**: `POST`
- **URL**: `/api/sessions/admin/logout/all`
- **Защита**: `JwtAuthGuard`, `AdminGuard`
- **Описание**: Завершает все активные сессии в системе.

#### **Получение сессий пользователя**

- **Метод**: `GET`
- **URL**: `/api/sessions/admin/:id`
- **Защита**: `JwtAuthGuard`, `ModeratorGuard`
- **Описание**: Возвращает список всех активных сессий указанного пользователя.

#### **Завершение всех сессий пользователя**

- **Метод**: `POST`
- **URL**: `/api/sessions/admin/logout/user/:id`
- **Защита**: `JwtAuthGuard`, `ModeratorGuard`
- **Описание**: Завершает все активные сессии указанного пользователя.

#### **Завершение конкретной сессии пользователя**

- **Метод**: `POST`
- **URL**: `/api/sessions/admin/logout/session/`
- **Защита**: `JwtAuthGuard`, `ModeratorGuard`
- **Описание**: Завершает указанную сессию пользователя.
- **Тело запроса**:
    ```json
    {
        "user_id": "string",
        "session_id": "string"
    }
    ```

---

### 4. **Управление сессиями для пользователя**

#### **Получение своих сессий**

- **Метод**: `GET`
- **URL**: `/api/sessions/user`
- **Защита**: `JwtAuthGuard`
- **Описание**: Возвращает список активных сессий текущего пользователя.

#### **Завершение всех своих сессий**

- **Метод**: `POST`
- **URL**: `/api/sessions/user/logout/`
- **Защита**: `JwtAuthGuard`
- **Описание**: Завершает все активные сессии текущего пользователя.

#### **Завершение одной из своих сессий**

- **Метод**: `POST`
- **URL**: `/api/sessions/user/logout/session/`
- **Защита**: `JwtAuthGuard`
- **Описание**: Завершает указанную сессию текущего пользователя.
- **Тело запроса**:
    ```json
    {
        "session_id": "string"
    }
    ```

---

### 5. **Управление пользователями**

#### **Добавление нового пользователя**

- **Метод**: `POST`
- **URL**: `/api/user/add`
- **Описание**: Регистрирует нового пользователя.
- **Тело запроса**:
    ```json
    {
        "email": "string",
        "password": "string",
        "name": "string"
    }
    ```

#### **Получение пользователя по ID**

- **Метод**: `GET`
- **URL**: `/api/user/:id`
- **Описание**: Возвращает данные указанного пользователя.

#### **Удаление пользователя**

- **Метод**: `DELETE`
- **URL**: `/api/user/:id`
- **Защита**: `JwtAuthGuard`, `ModeratorOrSelfGuard`
- **Описание**: Удаляет пользователя с указанным ID.

#### **Получение всех пользователей**

- **Метод**: `GET`
- **URL**: `/api/user`
- **Описание**: Возвращает список всех зарегистрированных пользователей.

#### **Подтверждение аккаунта (отправка кода)**

- **Метод**: `POST`
- **URL**: `/api/user/confirm`
- **Защита**: `JwtAuthGuard`
- **Описание**: Отправляет код подтверждения на Email текущего пользователя.

#### **Подтверждение аккаунта (проверка кода)**

- **Метод**: `PATCH`
- **URL**: `/api/user/confirm`
- **Защита**: `JwtAuthGuard`
- **Описание**: Проверяет введенный код подтверждения и возвращает hash
- **Тело запроса**:
    ```json
    {
        "hash": "string",
        "code": "number"
    }
    ```

---
